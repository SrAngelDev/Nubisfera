<div class="weather-display-container" *ngIf="municipio" @fadeInOut>

  <!-- Estado de Carga -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner">
      <div class="spinner-inner"></div>
    </div>
    <h3 class="loading-title">Obteniendo la predicciÃ³n...</h3>
    <p class="loading-subtitle">Consultando los datos para <strong>{{ municipio.nombre }}</strong></p>
  </div>

  <!-- Estado de Error -->
  <div *ngIf="error && !isLoading" class="error-state">
    <div class="error-icon">ğŸ˜”</div>
    <h3 class="error-title">Â¡Vaya! Hubo un problema</h3>
    <p class="error-message">{{ error }}</p>
    <button class="retry-btn" (click)="retryLoad()">
      <span class="retry-icon">ğŸ”„</span>
      <span>Reintentar</span>
    </button>
  </div>

  <!-- Contenido de la PredicciÃ³n -->
  <div *ngIf="prediccion && !isLoading && !error" class="prediction-content">

    <!-- Cabecera de la PredicciÃ³n -->
    <header class="prediction-header">
      <div class="location-info">
        <h2 class="municipio-name">{{ prediccion.nombre }}</h2>
        <p class="provincia-name">{{ prediccion.provincia }}</p>
      </div>
      <div class="prediction-badge">
        <span class="badge-icon">{{ tipoPrecision === 'diaria' ? 'ğŸ“…' : 'â°' }}</span>
        <span>{{ tipoPrecision === 'diaria' ? 'PredicciÃ³n Semanal' : 'PredicciÃ³n por Horas' }}</span>
      </div>
    </header>

    <!-- PredicciÃ³n Diaria -->
    <ng-container *ngIf="tipoPrecision === 'diaria'">
      <div class="daily-grid">
        <div 
          *ngFor="let dia of getDiasFuturos(); let i = index"
          class="day-card"
          [class.is-today]="isToday(dia.fecha)"
          [@slideIn]="i"
        >
          <div class="day-card-header">
            <p class="day-name">{{ getDayName(dia.fecha) }}</p>
            <p class="day-date">{{ formatDate(dia.fecha, 'd MMM') }}</p>
          </div>
          <div class="day-card-body">
            <div class="weather-icon" [innerHTML]="getWeatherIcon(dia.estadoCielo[0]?.value || '') | safeHtml"></div>
            <p class="weather-description">{{ getWeatherDescription(dia.estadoCielo[0]?.value || '') }}</p>
          </div>
          <div class="day-card-footer">
            <div class="temperature">
              <span class="temp-max">{{ dia.temperatura.maxima }}Â°</span>
              <span class="temp-min">{{ dia.temperatura.minima }}Â°</span>
            </div>
            <div class="precipitation">
              <span class="precip-icon">ğŸ’§</span>
              <span>{{ dia.probPrecipitacion[0]?.value || 0 }}%</span>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- PredicciÃ³n Horaria -->
    <ng-container *ngIf="tipoPrecision === 'horaria'">
      <div class="hourly-forecast">
        <div *ngFor="let dia of getDiasConHoras(); let diaIndex = index" class="hourly-day-section">
          <ng-container>
            <div class="hourly-day-header">
              <h3 class="hourly-day-title">
                <span class="day-badge">{{ getDayName(dia.fecha) }}</span>
                <span class="day-date-detail">{{ formatDate(dia.fecha, 'd MMM') }}</span>
              </h3>
              <div class="day-temp-range">
                <span class="temp-range-label">Rango:</span>
                <span class="temp-max-badge">{{ dia.temperatura.maxima || 'N/A' }}Â°</span>
                <span class="temp-separator">/</span>
                <span class="temp-min-badge">{{ dia.temperatura.minima || 'N/A' }}Â°</span>
              </div>
            </div>
            <div class="hourly-scroll-container">
              <div class="hourly-grid">
                <div *ngFor="let hora of getHorasCombinadas(dia); let i = index" 
                     class="hour-card" 
                     [@slideIn]="i"
                     [class.no-data]="hora.temperatura === '--'">
                  <div class="hour-header">
                    <p class="hour-time">{{ formatHora(hora.periodo) }}</p>
                  </div>
                  <div class="hour-body">
                    <div class="hour-icon" [innerHTML]="getWeatherIcon(hora.estadoCielo) | safeHtml"></div>
                    <p class="weather-desc-mini">{{ getWeatherDescription(hora.estadoCielo) }}</p>
                  </div>
                  <div class="hour-footer">
                    <div class="hour-temp-container">
                      <span class="temp-icon">ğŸŒ¡ï¸</span>
                      <span class="hour-temp" [class.estimated]="!hora.esReal">
                        {{ hora.temperatura }}Â°
                      </span>
                    </div>
                    <div class="hour-precip">
                      <span class="precip-icon">ğŸ’§</span>
                      <span class="precip-value">{{ hora.probPrecipitacion }}%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </ng-container>

    <!-- Pie de la PredicciÃ³n -->
    <footer class="prediction-footer">
      <p class="data-source">
        <span class="source-icon">ğŸ“¡</span>
        Datos proporcionados por <strong>AEMET</strong>
      </p>
      <p *ngIf="prediccion.timestamp" class="last-updated">
        <span class="update-icon">ğŸ•</span>
        Actualizado: {{ prediccion.timestamp | date:'medium':'es-ES' }}
      </p>
    </footer>

  </div>
</div>